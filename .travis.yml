sudo: required
dist: trusty
language: rust
services: docker
cache: cargo

rust:
  - stable
os:
  - linux

before_install:
  - source ~/.cargo/env || true
  - rustup self update
  - sudo apt-get update -q
  - sudo pip install awscli

install:
  - sudo apt-get install ruby ruby-dev rubygems-integration build-essential
  - gem install --no-ri --no-rdoc fpm
  - cargo install --force cross
  - rustup component add rustfmt-preview

script:
  - |
    if [ "$TRAVIS_BRANCH" == "master" ]; then
      cross build --release --target x86_64-unknown-linux-musl
    else
      cargo update
      cargo fmt --all -- --write-mode=diff
      cargo build
    fi

after_script:
  - |
    if [ "$TRAVIS_BRANCH" == "master" ]; then
      sh ci/build_apk.sh
    fi
